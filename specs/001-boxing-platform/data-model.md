# Data Model: Boxing Platform Mini-Program

**Feature**: [spec.md](spec.md)
**Date**: 2025-12-26
**Phase**: 1 - Data Model Design

## Overview

This document defines the database collections, fields, relationships, and validation rules for the Boxing Platform. All collections use WeChat Cloud Database (MongoDB-like NoSQL).

---

## Collections

### 1. `users` - User Accounts

Stores WeChat user information and role state.

```javascript
{
  _id: string,              // Auto-generated by Cloud Database
  openid: string,           // WeChat OpenID (never exposed to frontend)
  created_at: Date,         // Account creation time
  updated_at: Date,         // Last update time
  last_role: string,        // Last active role: "boxer" | "gym" | null
  has_boxer_profile: boolean,  // Whether user has created Boxer profile
  has_gym_profile: boolean,    // Whether user has created Gym profile
}
```

**Indexes**:
- `openid`: unique (primary identifier for WeChat user)

**Constraints**:
- `openid` is unique per WeChat user
- `openid` NEVER returned to frontend (Constitution Principle III)

**Validation Rules**:
- `openid`: required, string
- `last_role`: optional, enum ["boxer", "gym", null]
- `has_boxer_profile`: boolean, default false
- `has_gym_profile`: boolean, default false

---

### 2. `boxers` - Boxer Profiles

Stores boxer profile information.

```javascript
{
  _id: string,              // Auto-generated
  user_id: string,          // Reference to users._id (NOT openid)
  nickname: string,         // Required: Display name
  gender: string,           // Required: "male" | "female" (non-editable after creation)
  birthdate: Date,          // Required: Birth date (non-editable after creation)
  height: number,           // Required: Height in cm
  weight: number,           // Required: Weight in kg
  city: string,             // Optional: Current city
  gym_id: string,           // Optional: Reference to gyms._id
  phone: string,            // Optional: Contact phone
  record_wins: number,      // Optional: Wins count
  record_losses: number,    // Optional: Losses count
  record_draws: number,     // Optional: Draws count
  location: {               // Optional: Coordinates for distance filtering
    latitude: number,
    longitude: number
  },
  created_at: Date,
  updated_at: Date
}
```

**Indexes**:
- `user_id`: unique (one boxer profile per user)
- `city`: for filtering by city
- `location.geospatial`: for distance queries (geospatial index)
- Compound: `city + birthdate` (for age filtering by city)
- Compound: `city + weight` (for weight filtering by city)

**Constraints**:
- `gender` and `birthdate` cannot be modified after creation (FR-018)
- `user_id` unique (one boxer per user)

**Validation Rules**:
- `nickname`: required, string, 1-50 characters
- `gender`: required, enum ["male", "female"]
- `birthdate`: required, Date, must be past date
- `height`: required, number, 100-250 cm
- `weight`: required, number, 30-200 kg
- `city`: optional, string
- `gym_id`: optional, reference to gyms._id
- `phone`: optional, string, valid phone format
- `record_wins/losses/draws`: optional, non-negative integers

---

### 3. `gyms` - Gym Profiles

Stores gym profile information.

```javascript
{
  _id: string,              // Auto-generated
  user_id: string,          // Reference to users._id (owner/creator)
  name: string,             // Required: Gym name
  address: string,          // Required: Street address
  location: {               // Required: Coordinates
    latitude: number,
    longitude: number
  },
  city: string,             // Derived from location or explicit
  phone: string,            // Required: Contact phone
  icon_url: string,         // Optional: Cloud Storage URL
  created_at: Date,
  updated_at: Date
}
```

**Indexes**:
- `user_id`: unique (one gym per user)
- `city`: for filtering by city
- `location.geospatial`: for distance queries (geospatial index)

**Constraints**:
- `user_id` unique (one gym per user)

**Validation Rules**:
- `name`: required, string, 1-100 characters
- `address`: required, string, 1-200 characters
- `location.latitude`: required, number, -90 to 90
- `location.longitude`: required, number, -180 to 180
- `phone`: required, string, valid phone format
- `icon_url`: optional, string, valid URL

---

### 4. `counters` - Aggregate Counts

Stores cached aggregate counts for performance.

```javascript
{
  _id: string,              // "boxer_count" | "gym_count"
  count: number,            // Current count
  updated_at: Date
}
```

**Usage**:
- Updated atomically when profiles are created/deleted
- Read frequently for dashboard display

---

## Entity Relationships

```
users (1) ----< (1) boxers
users (1) ----< (1) gyms
boxers (0..1) ----> (0..1) gyms  (gym association)
```

**Relationship Rules**:
- One User → One BoxerProfile (max)
- One User → One GymProfile (max)
- One Boxer → Zero or One Gym (gym association via `gym_id`)
- One Gym → Many Boxers (reverse association, no direct foreign key)

---

## Data Flow & Transactions

### Boxer Profile Creation (with Transaction)

```javascript
// Transaction: Create boxer profile + update user
const transaction = db.startTransaction();

try {
  // 1. Create boxer profile
  const boxer = await transaction.collection('boxers').add({
    data: { ...boxerData, user_id: userId }
  });

  // 2. Update user record
  await transaction.collection('users').doc(userId).update({
    data: { has_boxer_profile: true, last_role: 'boxer' }
  });

  // 3. Update counter
  await transaction.collection('counters').doc('boxer_count').update({
    data: { count: db.command.inc(1) }
  });

  await transaction.commit();
} catch (e) {
  await transaction.rollback();
  throw e;
}
```

### Gym Profile Creation (with Transaction)

```javascript
// Transaction: Create gym profile + update user
const transaction = db.startTransaction();

try {
  // 1. Create gym profile
  const gym = await transaction.collection('gyms').add({
    data: { ...gymData, user_id: userId }
  });

  // 2. Update user record
  await transaction.collection('users').doc(userId).update({
    data: { has_gym_profile: true, last_role: 'gym' }
  });

  // 3. Update counter
  await transaction.collection('counters').doc('gym_count').update({
    data: { count: db.command.inc(1) }
  });

  await transaction.commit();
} catch (e) {
  await transaction.rollback();
  throw e;
}
```

---

## OpenID Protection (Constitution Principle III)

**Frontend Receives**:
```javascript
// Cloud function response - NO openid
{
  errcode: 0,
  data: {
    user_id: "abc123...",  // Hash of openid, non-reversible
    roles: {
      has_boxer_profile: true,
      has_gym_profile: false
    },
    last_role: "boxer"
  }
}
```

**Server-Side Only**:
```javascript
// Cloud function - openid used here
const { openid } = cloud.getWXContext();
const user_id = hash(openid);  // Non-reversible hash for frontend
```

---

## Field Immutability

**Boxer Profile - Non-Editable After Creation**:
- `gender`: Cannot be modified (FR-018)
- `birthdate`: Cannot be modified (FR-018)

**Implementation**:
- Cloud function `boxer/update` checks if these fields are present in update request
- Reject request with error if attempted

---

## Optional Fields Handling

**Frontend Display Logic**:
```javascript
// Hide or show "not provided" for optional fields
{
  phone: profile.phone || "未提供",
  city: profile.city || "未提供",
  gym: profile.gym_id ? gymName : "未关联拳馆",
  record: profile.record_wins !== null
    ? `${profile.record_wins}胜${profile.record_losses}负${profile.record_draws}平`
    : "未填写"
}
```

---

## Geospatial Queries

**Distance Calculation (Haversine)**:
```javascript
// Cloud function: Calculate distance between two coordinates
function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371000;  // Earth radius in meters
  // ... Haversine formula
  return distance;  // in meters
}
```

**Nearby Gyms Query**:
```javascript
// Query gyms near user location
db.collection('gyms')
  .where({
    location: db.geo.near({
      geometry: db.Point({ latitude, longitude }),
      maxDistance: 50000  // 50km radius
    })
  })
  .get();
```

---

## Initialization Data

**Initial Counters**:
```javascript
{
  _id: "boxer_count",
  count: 0
}
{
  _id: "gym_count",
  count: 0
}
```

---

## Summary Table

| Collection | Documents | Indexes | Transactions |
|------------|-----------|---------|--------------|
| users | 1 per WeChat account | openid | Yes (profile creation) |
| boxers | 0-1 per user | user_id, city, location | Yes (creation, gym association) |
| gyms | 0-1 per user | user_id, city, location | Yes (creation) |
| counters | 2 fixed | _id | Yes (atomic updates) |

---

## Next Steps

See [contracts/](contracts/) for API specifications using this data model.

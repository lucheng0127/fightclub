# 微信订阅消息配置指南

## 功能说明

本系统支持以下微信订阅消息通知：
1. **新预约通知** - 拳手预约场地时通知拳馆
2. **取消预约通知** - 拳手取消预约时通知拳馆和其他预约拳手

## 配置步骤

### 1. 登录微信公众平台

访问 [微信公众平台](https://mp.weixin.qq.com/) 并登录你的小程序账号。

### 2. 进入订阅消息管理

导航到：**功能** → **订阅消息**

### 3. 选用模板

在订阅消息页面，点击"选用"或"公共模板库"，搜索并选用以下类型的模板：

#### 模板1：新预约通知
- **关键词建议**：
  - `thing1`：拳手昵称（必填，如"张三"）
  - `date2`：预约日期（必填，如"2024-01-15"）
  - `time3`：预约时间段（必填，如"14:00-16:00"）
  - `thing4`：事项（必填，如"场地预约"）

#### 模板2：取消预约通知
- **关键词建议**：
  - `thing1`：拳手昵称（必填）
  - `date2`：预约日期（必填）
  - `time3`：预约时间段（必填）
  - `thing4`：状态（必填，如"已取消预约"）

### 4. 获取模板ID

选用模板后，记录下每个模板的 **模板ID**（格式类似：`xxxxx`）。

### 5. 更新云函数代码

在 `miniprogram/cloudfunctions/notification-send/index.js` 中，将模板ID替换到以下位置：

```javascript
// 第98行附近 - 新预约通知模板
const templateId = 'YOUR_NEW_BOOKING_TEMPLATE_ID'; // 替换为实际模板ID

// 第120行附近 - 取消预约通知模板
const templateId = 'YOUR_CANCEL_BOOKING_TEMPLATE_ID'; // 替换为实际模板ID
```

### 6. 调整模板变量

根据你选用的实际模板，调整 `data` 对象中的字段名称：

```javascript
const data = {
  // 根据模板定义，key 可能是 thing1, date2, time3 等
  thing1: { value: boxerName },
  date2: { value: slotInfo.date },
  time3: { value: `${slotInfo.start_time}-${slotInfo.end_time}` },
  thing4: { value: '场地预约' }
};
```

### 7. 重新部署云函数

修改完成后，需要重新上传并部署 `notification-send` 云函数。

## 用户订阅流程

用户首次使用时需要订阅消息，前端需要调用订阅消息API：

```javascript
// 示例代码（已在相应页面中集成）
wx.requestSubscribeMessage({
  tmplIds: ['YOUR_TEMPLATE_ID'],
  success: (res) => {
    console.log('订阅成功', res);
  }
});
```

## 注意事项

1. **模板ID替换**：务必将 `YOUR_TEMPLATE_ID_HERE` 替换为实际的模板ID
2. **变量限制**：微信订阅消息的变量有长度限制，"thing"类型不超过20个字符
3. **跳转页面**：点击消息后跳转的小程序页面路径要确保正确
4. **订阅状态**：用户可以拒绝订阅或之后取消订阅，订阅消息发送失败不影响主流程
5. **发送频率**：微信对订阅消息的发送频率有限制，请遵守平台规则

## 测试步骤

1. 配置好模板后，在小程序中测试预约功能
2. 检查云函数日志确认订阅消息是否发送
3. 在微信"服务通知"中查看是否收到推送

## 故障排查

如果消息未收到：
1. 检查云函数日志是否有错误信息
2. 确认用户是否已授权订阅消息
3. 确认模板ID是否正确
4. 确认变量格式是否符合模板要求

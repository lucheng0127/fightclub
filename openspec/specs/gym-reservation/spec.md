# gym-reservation Specification

## Purpose
TBD - created by archiving change 003-add-gym-reservation. Update Purpose after archive.
## Requirements
### Requirement: 拳馆发布场地时间段

系统 SHALL 允许已审核通过的拳馆发布未来一周内的可用场地时间段。

#### Scenario: 发布成功
- **WHEN** 拳馆填写日期、开始时间、结束时间、最大人数并提交
- **THEN** 时间段发布成功，系统返回 slot_id

#### Scenario: 日期范围验证
- **WHEN** 拳馆尝试发布超出未来一周的日期
- **THEN** 系统拒绝并提示"日期必须在未来一周内"

#### Scenario: 时间有效性验证
- **WHEN** 拳馆填写的开始时间晚于或等于结束时间
- **THEN** 系统拒绝并提示"结束时间必须晚于开始时间"

#### Scenario: 时间冲突检查
- **WHEN** 拳馆发布与已发布时间段重叠的时间段
- **THEN** 系统拒绝并提示"该时间段已存在"

#### Scenario: 拳馆状态验证
- **WHEN** 未审核通过或被拒绝的拳馆尝试发布时间段
- **THEN** 系统拒绝并提示"请先通过审核"

### Requirement: 拳馆查看已发布时间段

系统 SHALL 允许拳馆查看自己已发布的所有时间段及其预约状态。

#### Scenario: 查看所有时间段
- **WHEN** 拳馆进入场地管理页面
- **THEN** 显示所有已发布的时间段，包括日期、时间、当前预约数、状态

#### Scenario: 时间段可编辑状态
- **WHEN** 时间段当前无任何预约
- **THEN** 显示"可编辑"标识，允许修改和删除

#### Scenario: 时间段不可编辑状态
- **WHEN** 时间段有拳手预约
- **THEN** 显示"不可编辑"标识，隐藏修改和删除按钮

### Requirement: 拳馆修改时间段

系统 SHALL 允许拳馆修改无预约的时间段。

#### Scenario: 修改无预约时间段
- **WHEN** 拳馆修改无预约时间段的日期、时间或人数
- **THEN** 修改成功，时间段信息更新

#### Scenario: 有预约时拒绝修改
- **WHEN** 拳馆尝试修改有预约的时间段
- **THEN** 系统拒绝并提示"已有拳手预约，无法修改"

#### Scenario: 修改后时间冲突检查
- **WHEN** 修改后的时间段与自身其他时间段冲突
- **THEN** 系统拒绝并提示"该时间段已存在"

### Requirement: 拳馆撤销时间段

系统 SHALL 允许拳馆撤销无预约的时间段。

#### Scenario: 撤销无预约时间段
- **WHEN** 拳馆删除无预约的时间段
- **THEN** 时间段状态更新为 cancelled

#### Scenario: 有预约时拒绝撤销
- **WHEN** 拳馆尝试删除有预约的时间段
- **THEN** 系统拒绝并提示"已有拳手预约，无法撤销"

### Requirement: 拳手浏览可用时间段

系统 SHALL 允许拳手浏览未来一周内所有拳馆发布的可用时间段。

#### Scenario: 查看所有可用时间段
- **WHEN** 拳手进入可预约场地页面
- **THEN** 显示所有激活状态的时间段，按日期排序

#### Scenario: 按拳馆筛选
- **WHEN** 拳手选择特定拳馆
- **THEN** 只显示该拳馆的时间段

#### Scenario: 按日期范围筛选
- **WHEN** 拳手选择日期范围
- **THEN** 只显示该日期范围内的时间段

#### Scenario: 显示时间段详细信息
- **WHEN** 显示时间段列表
- **THEN** 每个时间段显示拳馆名称、日期时间、最大人数、当前预约数、剩余名额

#### Scenario: 已预约标识
- **WHEN** 拳手已经预约某个时间段
- **THEN** 该时间段显示"已预约"标识

#### Scenario: 名额已满标识
- **WHEN** 时间段预约人数达到上限
- **THEN** 该时间段显示"名额已满"且不可预约

### Requirement: 拳手预约时间段

系统 SHALL 允许拳手预约有空位的时间段。

#### Scenario: 预约成功
- **WHEN** 拳手点击预约有空位的时间段
- **THEN** 预约成功，时间段预约数增加，拳馆收到消息通知

#### Scenario: 名额已满拒绝预约
- **WHEN** 拳手尝试预约已满的时间段
- **THEN** 系统拒绝并提示"该时间段名额已满"

#### Scenario: 重复预约检查
- **WHEN** 拳手尝试预约已预约的时间段
- **THEN** 系统拒绝并提示"您已预约该时间段"

#### Scenario: 并发预约人数限制
- **WHEN** 多个拳手同时预约最后剩余名额
- **THEN** 只有在事务检查时仍有空位的预约成功，其他收到"名额已满"提示

### Requirement: 拳手取消预约

系统 SHALL 允许拳手在时间段结束前半小时取消预约。

#### Scenario: 取消预约成功
- **WHEN** 拳手在截止时间前取消预约
- **THEN** 预约状态更新为 cancelled，时间段预约数减少，拳馆和其他拳手收到消息通知

#### Scenario: 超过截止时间拒绝取消
- **WHEN** 拳手在时间段结束前半小时内尝试取消
- **THEN** 系统拒绝并提示"已超过取消截止时间"

#### Scenario: 非本人预约拒绝取消
- **WHEN** 拳手尝试取消其他拳手的预约
- **THEN** 系统拒绝并提示"无权操作"

### Requirement: 查看时间段预约拳手列表

系统 SHALL 允许拳馆和拳手查看特定时间段的预约拳手信息。

#### Scenario: 拳馆查看预约列表
- **WHEN** 拳馆点击某个时间段
- **THEN** 显示该时间段所有预约拳手的昵称、身高、体重、城市、预约时间

#### Scenario: 拳手查看预约列表
- **WHEN** 拳手点击某个时间段详情
- **THEN** 显示该时间段所有预约拳手的信息

#### Scenario: 显示时间段和拳馆信息
- **WHEN** 查看预约列表
- **THEN** 页面顶部显示时间段信息（日期、时间）和拳馆信息（名称、地址）

### Requirement: 预约消息通知

系统 SHALL 在预约和取消预约时发送消息通知。

#### Scenario: 新预约通知拳馆
- **WHEN** 拳手预约时间段
- **THEN** 拳馆收到应用内消息和微信订阅消息，包含拳手昵称、时间段信息

#### Scenario: 取消预约通知拳馆
- **WHEN** 拳手取消预约
- **THEN** 拳馆收到应用内消息和微信订阅消息，包含取消拳手昵称、剩余名额

#### Scenario: 取消预约通知其他拳手
- **WHEN** 拳手取消预约
- **THEN** 该时间段的其他预约拳手收到应用内消息，通知有拳手取消预约

#### Scenario: 应用内消息列表
- **WHEN** 用户进入消息中心
- **THEN** 显示所有未读和已读的通知消息

### Requirement: 事务安全

系统 SHALL 确保预约和取消预约操作使用数据库事务保证原子性。

#### Scenario: 预约事务
- **WHEN** 创建预约记录和更新时间段预约数
- **THEN** 操作要么完全成功，要么完全回滚，不允许预约数与实际记录不符

#### Scenario: 取消预约事务
- **WHEN** 更新预约状态和减少时间段预约数
- **THEN** 操作要么完全成功，要么完全回滚，预约数保持准确

### Requirement: 数据隐私

系统 SHALL NOT 在任何前端响应中暴露原始 OpenID。

#### Scenario: 预约记录不暴露 OpenID
- **WHEN** 返回预约列表给前端
- **THEN** 数据中不得包含原始 OpenID，使用 boxer_id 关联


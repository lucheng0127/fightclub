# 任务列表：拳手预约拳馆功能

## 第一阶段：数据库和云函数基础

### 1. 创建数据库集合和索引
- [x] 在微信云开发控制台创建 `gym_slots` 集合
- [x] 在微信云开发控制台创建 `slot_bookings` 集合
- [x] 在微信云开发控制台创建 `notifications` 集合
- [x] 为 `gym_slots` 添加复合索引：`gym_id + date + status`
- [x] 为 `gym_slots` 添加复合索引：`date + status`
- [x] 为 `slot_bookings` 添加复合索引：`slot_id + status`
- [x] 为 `slot_bookings` 添加复合索引：`boxer_id + status`

### 2. 实现云函数 - gym-slot-publish
- [x] 创建云函数目录和基础结构
- [x] 实现日期范围验证（未来一周内）
- [x] 实现时间有效性验证
- [x] 实现时间段冲突检查
- [x] 使用事务创建时间段记录
- [x] 测试发布成功场景
- [x] 测试日期超出范围拒绝场景
- [x] 测试时间冲突拒绝场景

### 3. 实现云函数 - gym-slot-list
- [x] 创建云函数目录和基础结构
- [x] 实现查询拳馆自己的时间段
- [x] 计算每个时间段的当前预约数
- [x] 判断每个时间段是否可编辑
- [x] 测试查询返回正确数据

### 4. 实现云函数 - gym-slot-update
- [x] 创建云函数目录和基础结构
- [x] 实现预约数检查（无预约时才可修改）
- [x] 实现时间段冲突检查
- [x] 使用事务更新时间段记录
- [x] 测试无预约时修改成功
- [x] 测试有预约时拒绝修改

### 5. 实现云函数 - gym-slot-delete
- [x] 创建云函数目录和基础结构
- [x] 实现预约数检查（无预约时才可删除）
- [x] 实现软删除（状态更新为 cancelled）
- [x] 测试无预约时删除成功
- [x] 测试有预约时拒绝删除

## 第二阶段：拳手预约功能

### 6. 实现云函数 - slot-list
- [x] 创建云函数目录和基础结构
- [x] 实现按日期、拳馆、城市筛选
- [x] 关联查询拳馆信息
- [x] 计算剩余名额
- [x] 判断当前用户是否已预约
- [x] 测试返回正确的可用时间段列表

### 7. 实现云函数 - slot-book
- [x] 创建云函数目录和基础结构
- [x] 实现时间段状态和人数上限检查
- [x] 实现重复预约检查
- [x] 使用事务创建预约记录并更新时间段预约数
- [x] 实现消息通知（应用内消息）
- [x] 测试预约成功场景
- [x] 测试名额已满拒绝场景
- [x] 测试重复预约拒绝场景

### 8. 实现云函数 - slot-cancel
- [x] 创建云函数目录和基础结构
- [x] 实现取消截止时间检查（结束前半小时）
- [x] 实现预约所有权验证
- [x] 使用事务更新预约状态并减少时间段预约数
- [x] 实现消息通知给拳馆和其他拳手
- [x] 测试截止前取消成功
- [x] 测试超时拒绝取消
- [x] 测试非本人拒绝取消

### 9. 实现云函数 - slot-bookings
- [x] 创建云函数目录和基础结构
- [x] 实现查询时间段信息
- [x] 实现关联查询预约拳手列表
- [x] 返回拳手的昵称、身高、体重等信息
- [x] 测试返回正确的预约列表

## 第三阶段：消息通知

### 10. 实现云函数 - notification-list
- [x] 创建云函数目录和基础结构
- [x] 实现查询用户的通知消息
- [x] 支持按已读/未读筛选
- [x] 实现标记已读功能

### 11. 集成微信订阅消息
- [ ] 在微信公众平台配置订阅消息模板（需手动操作）
- [x] 在云函数中实现订阅消息发送（notification-send）
- [x] 测试新预约通知发送
- [x] 测试取消预约通知发送

## 第四阶段：前端页面 - 拳馆侧

### 12. 创建拳馆场地管理页面
- [x] 创建 `pages/gym/slot-manage/slot-manage` 页面
- [x] 实现页面布局和导航栏
- [x] 调用 `gym-slot-list` 获取时间段列表
- [x] 渲染时间段列表卡片（日期、时间、预约数、状态）
- [x] 显示可编辑/不可编辑状态标识
- [x] 添加发布新时间段按钮
- [x] 测试页面显示正确

### 13. 创建发布时间段页面
- [x] 创建 `pages/gym/slot-publish/slot-publish` 页面
- [x] 实现日期选择器（限制未来一周）
- [x] 实现开始时间选择器
- [x] 实现结束时间选择器
- [x] 实现最大人数输入
- [x] 实现表单验证
- [x] 调用 `gym-slot-publish` 提交
- [x] 测试发布成功和失败场景

### 14. 创建编辑时间段页面
- [x] 创建 `pages/gym/slot-edit/slot-edit` 页面
- [x] 加载现有时间段数据
- [x] 实现日期、时间、人数编辑
- [x] 调用 `gym-slot-update` 更新
- [x] 实现删除功能（调用 `gym-slot-delete`）
- [x] 添加查看预约列表入口
- [x] 测试编辑和删除功能

## 第五阶段：前端页面 - 拳手侧

### 15. 创建可预约场地列表页面
- [x] 创建 `pages/boxer/slot-list/slot-list` 页面
- [x] 实现筛选器（日期、拳馆、城市）
- [x] 调用 `slot-list` 获取可用时间段
- [x] 渲染时间段卡片（拳馆信息、时间、剩余名额）
- [x] 显示已预约/名额已满状态
- [x] 实现点击查看详情
- [x] 测试页面显示和筛选

### 16. 创建时间段详情页面
- [x] 创建 `pages/common/slot-detail/slot-detail` 页面
- [x] 显示时间段完整信息
- [x] 显示拳馆信息
- [x] 实现预约/取消预约按钮
- [x] 调用 `slot-book` 或 `slot-cancel`
- [x] 添加查看已预约拳手入口
- [x] 测试预约和取消功能

### 17. 创建预约拳手列表页面
- [x] 创建 `pages/common/slot-bookings/slot-bookings` 页面
- [x] 调用 `slot-bookings` 获取数据
- [x] 显示时间段和拳馆信息
- [x] 渲染预约拳手列表卡片
- [x] 测试页面显示正确

### 17.1. 拳手我的预约功能（新增）
- [x] 创建 `my-bookings` 云函数
- [x] 实现查询用户预约记录（支持状态筛选）
- [x] 计算取消截止时间和剩余分钟数
- [x] 创建 `pages/boxer/my-bookings/my-bookings` 页面
- [x] 实现状态切换（进行中/全部/已取消）
- [x] 显示预约卡片（拳馆、时间、倒计时）
- [x] 实现查看详情和取消预约功能
- [x] 在拳手 Dashboard 添加"我的预约"入口
- [x] 注册页面到 app.json

### 17.2. 拳馆场地编辑功能增强（新增）
- [x] 在场地管理页面添加显式编辑/撤销按钮
- [x] 根据时间段状态显示/隐藏操作按钮
- [x] 实现编辑跳转功能
- [x] 实现撤销确认对话框
- [x] 添加按钮加载状态

## 第六阶段：消息通知和优化

### 18. 创建消息中心页面
- [x] 创建 `pages/common/notifications/notifications` 页面
- [x] 调用 `notification-list` 获取消息
- [x] 渲染消息列表（区分已读/未读）
- [x] 实现点击查看详情
- [x] 实现标记已读功能
- [x] 测试消息显示和操作

### 19. Dashboard 入口集成
- [x] 在拳馆 Dashboard 添加"场地管理"入口
- [x] 在拳手 Dashboard 添加"可预约场地"入口
- [x] 在顶部导航添加消息中心入口（带未读数）
- [x] 测试导航跳转正确

### 20. 测试和优化
- [ ] 完整功能测试（发布→预约→查看→取消）
- [ ] 并发预约测试
- [ ] 边界条件测试（日期范围、取消截止时间）
- [ ] 权限验证测试
- [ ] 性能测试（大量时间段数据）
- [ ] 错误处理和用户提示优化

## 第七阶段：数据清理（新增）

### 21. 实现定时数据清理
- [x] 创建 `data-cleanup` 云函数
- [x] 配置定时触发器（每天凌晨2点执行）
- [x] 实现 `gym_slots` 清理逻辑（保留往前3天和往后7天）
- [x] 实现 `slot_bookings` 清理逻辑（保留往前3天和往后7天）
- [x] 实现 `notifications` 清理逻辑（保留最近30天）
- [x] 更新数据库文档说明数据保留策略
- [ ] 部署云函数并测试定时触发
- [ ] 在云开发控制台验证定时器配置

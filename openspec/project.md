# Project Context

## Core Principles

### I. WeChat Mini Program + Cloud Development First

**技术栈优先原则**:
- 本项目以微信小程序 + 微信云开发作为第一技术选项
- 不允许在未明确需求的情况下引入外部服务和第三方后端
- 所有架构决策必须优先考虑微信生态系统能力
- 如需引入外部服务，必须先评估微信云开发原生替代方案

**理由**: 保持技术栈简洁，降低维护成本，充分利用微信生态优势，避免过度工程化。

### II. Business Correctness Above All

**业务正确性高于一切**:
- 功能实现必须符合业务需求和用户预期
- 代码正确性优先于代码优雅性
- 不允许为追求技术完美而牺牲业务逻辑正确性
- 所有异常情况必须有明确的业务处理规则

**理由**: 软件的最终价值是解决业务问题，技术手段服务于业务目标。

### III. OpenID Protection (NON-NEGOTIABLE)

**禁止暴露用户 OpenID**:
- OpenID 是用户敏感标识，严禁在任何前端、日志、错误信息中暴露
- 云函数返回给前端的数据不得包含原始 OpenID
- 如需前端关联用户数据，必须使用匿名化后的用户标识
- 数据库权限必须严格控制 OpenID 字段的访问

**理由**: OpenID 可用于关联用户身份，暴露会造成严重隐私安全问题。

### IV. Transaction Safety

**事务安全原则**:
- 不允许出现数据写入部分成功和部分失败的情况
- 多表操作必须使用数据库事务保证原子性
- 云函数操作必须实现适当的回滚机制
- 分布式场景必须考虑最终一致性补偿机制

**理由**: 数据一致性是系统可信度的基石，部分失败会导致数据不可用。

### V. Static Asset Management

**静态资源管理规范**:
- 需要使用图片等静态资源时，必须提示以下信息：
  - 资源类型（PNG/JPG/SVG 等）
  - 存放目录（如 `assets/images/`）
  - 文件命名规范
- 必须由开发者手动下载资源后再确认下一步
- 不允许自动从外部 URL 下载资源到项目

**理由**: 确保资源来源可控，避免版权问题，保持项目文件完整性。

### VI. Constitution Compliance

**宪法遵守原则**:
- 所有代码生成和修改必须遵守本宪法
- PR 评审必须检查宪法合规性
- 发现违宪代码必须拒绝或要求修正
- 宪法冲突时，业务正确性（原则 II）之外，其他原则同等重要

**理由**: 宪法是项目质量的一致性保障，所有参与者必须共同维护。

## Purpose

拳击平台微信小程序，用于连接拳击手和拳馆。核心功能包括：

- **用户授权与角色管理**：支持微信授权（用户信息 + 位置），用户可同时拥有拳手和拳馆双角色
- **拳手档案管理**：身高、体重、性别、昵称、出生日期（必填），战绩、城市、所属拳馆、电话（选填）
- **拳馆档案管理**：名称、地址及定位、电话（必填），拳馆图标（选填）
- **发现与筛选**：按城市、距离、年龄、体重等条件查找拳手和拳馆
- **档案详情查看**：展示完整档案信息，支持联系方式展示

**目标用户**：拳击手、拳馆经营者、拳击运动爱好者

## Tech Stack

**Primary Stack**:
- 前端: 微信小程序框架 (WXML, WXSS, JavaScript/TypeScript)
- 后端: 微信云开发 (云函数、云数据库、云存储)
- 数据库: 微信云数据库 (类 MongoDB)

**External Services**:
- 仅在明确需求且微信云开发无法满足时引入
- 需文档记录引入理由和替代方案评估

## Project Conventions

### Code Style

**文件命名**:
- 文件夹和文件使用 kebab-case（如 `profile-create/`、`filter-bar/`）
- 页面文件夹名与功能对应（如 `boxer/profile-create/`）

**前端代码**:
- 优先使用 ES6+ 语法
- 组件命名使用 PascalCase（如 `ProfileCard`）
- 函数命名使用 camelCase（如 `getBoxerProfile`）
- 常量命名使用 UPPER_SNAKE_CASE（如 `MAX_FILE_SIZE`）

**云函数**:
- 每个云函数单独一个文件夹
- 入口文件统一为 `index.js`
- 函数命名清晰表达操作（如 `create`、`update`、`list`）

**注释**:
- 关键业务逻辑必须添加中文注释
- 复杂算法或特殊情况需要说明原因

### Architecture Patterns

**项目结构**:
```
miniprogram/          # 前端页面和组件
├── pages/            # 页面（按功能组织）
│   ├── auth/         # 授权相关页面
│   ├── boxer/        # 拳手角色页面
│   ├── gym/          # 拳馆角色页面
│   └── common/       # 通用页面
├── components/       # 可复用组件
├── utils/           # 工具函数
└── styles/          # 全局样式

cloudfunctions/       # 云函数后端
├── auth/            # 授权相关云函数
├── boxer/           # 拳手档案操作
├── gym/             # 拳馆档案操作
└── common/          # 通用云函数
```

**前后端分离**:
- 前端页面通过 `wx.cloud.callFunction()` 调用云函数
- 云函数处理所有业务逻辑和数据库操作
- 前端只负责 UI 展示和用户交互

**数据流**:
```
用户操作 → 页面事件 → 云函数调用 → 数据库操作 → 返回结果 → 页面更新
```

**安全设计**:
- OpenID 仅在云函数中使用，不返回前端
- 所有数据库写操作使用事务保证原子性
- 敏感操作（如档案修改）需验证用户身份

### Testing Strategy

**测试环境**:
- 微信开发者工具模拟器（主要开发测试）
- 真机调试（iOS/Android 实际设备）

**测试类型**:
1. **功能测试**：验证所有用户场景和验收标准
2. **边界测试**：必填字段为空、超长输入、无效数据格式
3. **授权测试**：拒绝授权、单角色、双角色等场景
4. **性能测试**：大数据量（10000 拳手 + 1000 拳馆）下的加载和筛选性能
5. **安全测试**：确保 OpenID 不暴露、事务正确回滚

**性能目标**:
- 档案列表页面 3 秒内加载完成
- 筛选操作 2 秒内完成
- 距离计算精度 100 米内

**测试文档**:
- `tests/test-scenarios.md` 记录测试用例
- 云函数日志用于调试后端问题

### Git Workflow

**分支命名**:
- 功能分支：`001-boxing-platform` 格式（数字编号 + kebab-case 描述）
- 主分支：`main`

**工作流程**:
1. 从 OpenSpec change proposal 创建功能分支
2. 在功能分支上开发实现
3. 完成后创建 PR 合并到主分支
4. 合并后将 change proposal 归档到 `archive/`

**提交规范**:
- feat: 新功能
- fix: 修复 bug
- docs: 文档更新
- refactor: 代码重构
- style: 代码格式调整
- test: 测试相关

**示例**:
```
feat(boxer): add boxer profile creation page
fix(auth): handle location authorization denial
docs: update API documentation
```

## Domain Context

**拳击行业术语**:
- **拳手 (Boxer)**：从事拳击运动的运动员，拥有身高、体重、战绩等个人档案
- **拳馆 (Gym)**：提供拳击训练的场馆，拥有地址、联系方式、定位等场馆信息
- **战绩 (Record)**：拳手的比赛成绩，通常表示为 胜-负-平（如 10-2-1）
- **所属拳馆**：拳手训练或代表的拳馆，一个拳手最多属于一个拳馆

**用户角色**:
1. **拳手角色**：可创建个人档案，浏览其他拳手和拳馆
2. **拳馆角色**：可创建拳馆档案，浏览拳手和其他拳馆
3. **双角色用户**：同时拥有拳手和拳馆档案，可在两者间切换

**关键业务规则**:
- 拳手档案中性别和出生日期创建后不可修改
- 拳馆必须提供位置坐标（用于距离计算）
- 距离计算基于用户当前地理位置
- 未授权位置时不显示距离相关信息

## Important Constraints

**技术约束**:
- **不允许使用外部服务**：优先使用微信云开发原生能力，引入外部服务需充分评估
- **OpenID 隐私保护**：严禁在任何前端响应、日志、错误信息中暴露原始 OpenID
- **事务安全**：多数据库操作必须使用事务，不允许部分成功/失败
- **距离精度**：距离计算误差需控制在 100 米以内

**性能约束**:
- 支持 10,000 条拳手档案 + 1,000 条拳馆档案
- 列表页面加载时间 ≤ 3 秒
- 筛选操作响应时间 ≤ 2 秒

**业务约束**:
- 拳手性别和出生日期创建后不可修改
- 拳馆必须提供有效的地理定位坐标
- 一个用户可同时拥有拳手和拳馆两种角色

**数据约束**:
- 所有必填字段必须有值才能创建档案
- 可选字段未填写时应隐藏或显示为"未提供"

## External Dependencies

**微信平台能力**:
- **微信小程序 SDK**：`wx.*` API 系列用于小程序基础功能
- **微信云开发 SDK**：`wx.cloud.*` API 系列用于云函数、数据库、存储调用
- **微信授权服务**：`wx.getUserInfo()`、`wx.getUserProfile()` 获取用户信息
- **微信定位服务**：`wx.getLocation()` 获取用户位置，`wx.chooseLocation()` 选择位置

**微信云开发组件**:
- **云函数**：Node.js 运行时，处理业务逻辑
- **云数据库**：类 MongoDB NoSQL 数据库，支持事务
- **云存储**：用于存储拳馆图标等图片资源

**语言支持**:
- 仅支持简体中文
- 无需国际化

**目标平台**:
- 微信小程序（iOS / Android）
- 微信版本要求：根据实际开发时最低支持版本确定

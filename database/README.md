# 数据库集合创建说明

## 需要在微信云开发控制台手动创建的集合

### 1. gym_slots（拳馆场地时间段）

**创建方式**: 在微信开发者工具 → 云开发 → 数据库 → 添加集合

**索引配置**:
- 复合索引: `gym_id` + `date` + `status`
- 复合索引: `date` + `status`
- 唯一索引: `slot_id`

**数据保留策略**:
- 保留当前日期往前3天和往后7天的数据
- 超出范围的记录会被定时清理任务删除

### 2. slot_bookings（预约记录）

**索引配置**:
- 复合索引: `slot_id` + `status`
- 复合索引: `boxer_id` + `status`

**数据保留策略**:
- 保留当前日期往前3天和往后7天的数据
- 超出范围的记录会被定时清理任务删除

### 3. notifications（消息通知）

**索引配置**:
- 复合索引: `recipient_user_id` + `is_read`
- 单字段索引: `created_at`

**数据保留策略**:
- 保留最近30天的数据
- 超过30天的记录会被定时清理任务删除

## 定时数据清理

### data-cleanup 云函数

**触发方式**: 定时触发器（每天凌晨2点执行）

**清理规则**:
- `gym_slots`: 删除日期不在 [当前日期-3天, 当前日期+7天] 范围内的记录
- `slot_bookings`: 删除关联的过期时间段预约记录
- `notifications`: 删除创建时间超过30天的记录

**部署方式**:
1. 右键 `miniprogram/cloudfunctions/data-cleanup` 文件夹
2. 选择"上传并部署：云端安装依赖"
3. 在云开发控制台 → 云函数 → data-cleanup → 触发方式，确认定时触发器已配置

**手动测试**:
可以在云开发控制台手动触发该云函数进行测试，查看执行日志确认清理结果。

## 注意事项

1. 创建集合后不需要添加记录，云函数会自动创建数据
2. 索引可以在集合创建后添加
3. 集合权限可以设置为"仅创建者可读写"或"自定义安全规则"
4. 定时清理任务会在每天凌晨2点自动执行，无需手动操作
5. 删除的数据无法恢复，如需长期存储请在本地备份
